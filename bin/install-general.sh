#!/usr/bin/env bash
# install-general.sh -- 장군 패키지를 Kingdom 런타임에 설치
# Usage: install-general.sh <package-dir> [--force]
set -euo pipefail

BASE_DIR="${KINGDOM_BASE_DIR:-/opt/kingdom}"
source "$BASE_DIR/bin/lib/common.sh"

PACKAGE_DIR="${1:?Usage: install-general.sh <package-dir> [--force]}"
FORCE="${2:-}"

# --- 검증 ---

# 패키지 구조
[ -d "$PACKAGE_DIR" ] || { echo "ERROR: Package directory not found: $PACKAGE_DIR"; exit 1; }
[ -f "$PACKAGE_DIR/manifest.yaml" ] || { echo "ERROR: manifest.yaml not found"; exit 1; }
[ -f "$PACKAGE_DIR/prompt.md" ] || { echo "ERROR: prompt.md not found"; exit 1; }

# 이름 파싱 + 형식 검증
NAME=$(yq eval '.name' "$PACKAGE_DIR/manifest.yaml" 2>/dev/null)
[[ "$NAME" =~ ^gen-[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]] || { echo "ERROR: Invalid name: $NAME"; exit 1; }

# 이름 충돌
if [ -f "$BASE_DIR/config/generals/${NAME}.yaml" ] && [ "$FORCE" != "--force" ]; then
  echo "ERROR: '$NAME' already installed. Use --force to overwrite."
  exit 1
fi

# 이벤트 충돌 (다른 장군과 subscribes 겹침)
while IFS= read -r event_type; do
  [ -z "$event_type" ] && continue
  for existing in "$BASE_DIR/config/generals/"*.yaml; do
    [ -f "$existing" ] || continue
    existing_name=$(yq eval '.name' "$existing" 2>/dev/null)
    [ "$existing_name" = "$NAME" ] && continue
    if yq eval '.subscribes[]' "$existing" 2>/dev/null | grep -qx "$event_type"; then
      echo "ERROR: Event '$event_type' already claimed by $existing_name"
      exit 1
    fi
  done
done <<< "$(yq eval '.subscribes[]' "$PACKAGE_DIR/manifest.yaml" 2>/dev/null || true)"

# CC Plugin 경고 (실패 아닌 경고)
while IFS= read -r plugin; do
  [ -z "$plugin" ] && continue
  if [ -f "$HOME/.claude/settings.json" ]; then
    found=$(jq -r --arg n "$plugin" '.enabledPlugins // {} | keys[] | select(startswith($n + "@") or . == $n)' "$HOME/.claude/settings.json" | head -1)
    [ -z "$found" ] && echo "WARN: Plugin '$plugin' not in global settings. Install before running."
  fi
done <<< "$(yq eval '.cc_plugins[]' "$PACKAGE_DIR/manifest.yaml" 2>/dev/null || true)"

# --- 설치 ---

# 매니페스트 복사
cp "$PACKAGE_DIR/manifest.yaml" "$BASE_DIR/config/generals/${NAME}.yaml"

# 프롬프트 템플릿 복사
mkdir -p "$BASE_DIR/config/generals/templates"
cp "$PACKAGE_DIR/prompt.md" "$BASE_DIR/config/generals/templates/${NAME}.md"

# 엔트리 스크립트 자동 생성
mkdir -p "$BASE_DIR/bin/generals"
cat > "$BASE_DIR/bin/generals/${NAME}.sh" << ENTRY
#!/usr/bin/env bash
# Auto-generated by install-general.sh
BASE_DIR="\${KINGDOM_BASE_DIR:-/opt/kingdom}"
GENERAL_DOMAIN="${NAME}"
source "\$BASE_DIR/bin/lib/common.sh"
source "\$BASE_DIR/bin/lib/general/common.sh"
main_loop
ENTRY
chmod +x "$BASE_DIR/bin/generals/${NAME}.sh"

# 런타임 디렉토리 생성
mkdir -p "$BASE_DIR/state/$NAME"
mkdir -p "$BASE_DIR/memory/generals/$NAME"
mkdir -p "$BASE_DIR/workspace/$NAME"

# workspace/CLAUDE.md 확인 (없으면 config에서 복사)
if [ -f "$BASE_DIR/config/workspace-claude.md" ] && [ ! -f "$BASE_DIR/workspace/CLAUDE.md" ]; then
  cp "$BASE_DIR/config/workspace-claude.md" "$BASE_DIR/workspace/CLAUDE.md"
fi

# 장군별 general-claude.md → workspace/gen-{name}/CLAUDE.md로 복사
if [ -f "$PACKAGE_DIR/general-claude.md" ]; then
  cp "$PACKAGE_DIR/general-claude.md" "$BASE_DIR/workspace/$NAME/CLAUDE.md"
fi

echo "Installed general: $NAME"
echo "  Manifest:  config/generals/${NAME}.yaml"
echo "  Template:  config/generals/templates/${NAME}.md"
echo "  Script:    bin/generals/${NAME}.sh"
